<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico localStorage - POIs</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .diagnostico { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .poi-item { margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico localStorage - POIs</h1>
    
    <div id="results"></div>
    
    <button onclick="diagnosticarLocalStorage()">üîç Diagnosticar localStorage</button>
    <button onclick="limpiarLocalStorage()">üóëÔ∏è Limpiar localStorage</button>
    <button onclick="simularAgregarPOI()">‚ûï Simular Agregar POI</button>
    <button onclick="verificarConsistencia()">‚úÖ Verificar Consistencia</button>
    
    <script>
        const STORAGE_KEY = 'puerres_map_pois';
        
        function diagnosticarLocalStorage() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>üîç Diagnosticando localStorage...</h2>';
            
            // Verificar si localStorage est√° disponible
            const localStorageDisponible = typeof(Storage) !== "undefined";
            const div1 = document.createElement('div');
            div1.className = 'diagnostico ' + (localStorageDisponible ? 'success' : 'error');
            div1.innerHTML = `
                <strong>${localStorageDisponible ? '‚úÖ' : '‚ùå'} localStorage disponible:</strong> 
                ${localStorageDisponible ? 'S√≠' : 'No'}
            `;
            results.appendChild(div1);
            
            if (!localStorageDisponible) return;
            
            // Verificar datos guardados
            const datosGuardados = localStorage.getItem(STORAGE_KEY);
            const div2 = document.createElement('div');
            div2.className = 'diagnostico ' + (datosGuardados ? 'info' : 'warning');
            div2.innerHTML = `
                <strong>üì¶ Datos en localStorage:</strong><br>
                ${datosGuardados ? 'S√≠ hay datos guardados' : 'No hay datos guardados'}
            `;
            results.appendChild(div2);
            
            if (datosGuardados) {
                try {
                    const pois = JSON.parse(datosGuardados);
                    const div3 = document.createElement('div');
                    div3.className = 'diagnostico info';
                    div3.innerHTML = `
                        <strong>üìä An√°lisis de POIs guardados:</strong><br>
                        - Cantidad total: ${pois.length}<br>
                        - Tipo de datos: ${typeof pois}<br>
                        - Es array: ${Array.isArray(pois)}
                    `;
                    results.appendChild(div3);
                    
                    // Mostrar cada POI
                    const div4 = document.createElement('div');
                    div4.className = 'diagnostico info';
                    div4.innerHTML = '<strong>üìç POIs guardados:</strong><br>';
                    
                    pois.forEach((poi, index) => {
                        const poiDiv = document.createElement('div');
                        poiDiv.className = 'poi-item';
                        poiDiv.innerHTML = `
                            <strong>POI ${index + 1}:</strong> ${poi.name}<br>
                            - Coordenadas: ${poi.coords ? poi.coords.join(', ') : 'No disponibles'}<br>
                            - WhatsApp: ${poi.whatsapp || 'No disponible'}<br>
                            - Editado: ${poi.edited ? 'S√≠' : 'No'}<br>
                            - ID: ${poi.id || 'No disponible'}
                        `;
                        div4.appendChild(poiDiv);
                    });
                    
                    results.appendChild(div4);
                    
                } catch (error) {
                    const divError = document.createElement('div');
                    divError.className = 'diagnostico error';
                    divError.innerHTML = `
                        <strong>‚ùå Error al parsear datos:</strong><br>
                        ${error.message}
                    `;
                    results.appendChild(divError);
                }
            }
            
            // Verificar otros datos en localStorage
            const div5 = document.createElement('div');
            div5.className = 'diagnostico info';
            div5.innerHTML = `
                <strong>üóÇÔ∏è Todo el localStorage:</strong><br>
                <pre>${JSON.stringify(localStorage, null, 2)}</pre>
            `;
            results.appendChild(div5);
        }
        
        function limpiarLocalStorage() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar localStorage?')) {
                localStorage.removeItem(STORAGE_KEY);
                alert('‚úÖ localStorage limpiado');
                diagnosticarLocalStorage();
            }
        }
        
        function simularAgregarPOI() {
            const nuevoPOI = {
                id: 'test_' + Date.now(),
                name: 'POI de Prueba',
                description: 'Este es un POI de prueba',
                coords: [0.883000, -77.504000],
                whatsapp: '3009999999',
                icon: 'fas fa-map-marker-alt',
                color: '#ff0000',
                edited: true
            };
            
            try {
                // Obtener POIs existentes
                const datosGuardados = localStorage.getItem(STORAGE_KEY);
                let pois = datosGuardados ? JSON.parse(datosGuardados) : [];
                
                // Agregar nuevo POI
                pois.push(nuevoPOI);
                
                // Guardar de nuevo
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pois));
                
                alert('‚úÖ POI de prueba agregado exitosamente');
                diagnosticarLocalStorage();
            } catch (error) {
                alert('‚ùå Error al agregar POI de prueba: ' + error.message);
            }
        }
        
        function verificarConsistencia() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>‚úÖ Verificando consistencia...</h2>';
            
            const datosGuardados = localStorage.getItem(STORAGE_KEY);
            if (!datosGuardados) {
                const div = document.createElement('div');
                div.className = 'diagnostico warning';
                div.innerHTML = '‚ö†Ô∏è No hay datos para verificar';
                results.appendChild(div);
                return;
            }
            
            try {
                const pois = JSON.parse(datosGuardados);
                let errores = [];
                
                pois.forEach((poi, index) => {
                    if (!poi.name) errores.push(`POI ${index + 1}: Falta nombre`);
                    if (!poi.coords || !Array.isArray(poi.coords) || poi.coords.length !== 2) {
                        errores.push(`POI ${index + 1}: Coordenadas inv√°lidas`);
                    }
                    if (!poi.id) errores.push(`POI ${index + 1}: Falta ID`);
                });
                
                const div = document.createElement('div');
                div.className = 'diagnostico ' + (errores.length === 0 ? 'success' : 'error');
                div.innerHTML = `
                    <strong>${errores.length === 0 ? '‚úÖ' : '‚ùå'} Verificaci√≥n de consistencia:</strong><br>
                    ${errores.length === 0 ? 'Todos los POIs son v√°lidos' : errores.join('<br>')}
                `;
                results.appendChild(div);
                
            } catch (error) {
                const div = document.createElement('div');
                div.className = 'diagnostico error';
                div.innerHTML = `‚ùå Error al verificar: ${error.message}`;
                results.appendChild(div);
            }
        }
        
        // Diagnosticar autom√°ticamente al cargar
        window.onload = diagnosticarLocalStorage;
    </script>
</body>
</html>
